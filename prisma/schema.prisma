generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  buyer
  seller
  admin
}

enum BeatStatus {
  draft
  published
}

enum BeatVisibility {
  public
  unlisted
}

enum AssetType {
  preview
  mp3
  wav
  stems
  project
}

enum LicenseCode {
  Basic
  Premium
  Unlimited
}

enum OrderStatus {
  pending
  paid
  failed
  refunded
}

enum WebhookProvider {
  stripe
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  incomplete
}

enum SubscriptionTier {
  basic
  pro
  enterprise
}

model User {
  id               String      @id @default(uuid())
  email            String      @unique
  passwordHash     String
  role             UserRole    @default(buyer)
  displayName      String
  avatarUrl        String?
  refreshTokenHash String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  artist           Artist?
  cart             Cart?
  orders           Order[]
  subscriptions    Subscription[]
}

model Artist {
  id          String  @id @default(uuid())
  userId      String  @unique
  name        String
  bio         String?
  socialsJson Json?
  verified    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  beats       Beat[]
}

model Beat {
  id         String         @id @default(uuid())
  artistId   String
  title      String
  bpm        Int
  key        String?
  genres     String[]
  moods      String[]
  coverUrl   String?
  status     BeatStatus     @default(draft)
  visibility BeatVisibility @default(public)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  artist     Artist         @relation(fields: [artistId], references: [id], onDelete: Cascade)
  assets     Asset[]
  priceOverrides PriceOverride[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([artistId])
}

model Asset {
  id          String    @id @default(uuid())
  beatId      String
  type        AssetType
  storageKey  String
  durationSec Int?
  sizeBytes   Int?
  createdAt   DateTime @default(now())
  beat        Beat      @relation(fields: [beatId], references: [id], onDelete: Cascade)
  downloadGrants DownloadGrant[]

  @@index([beatId])
  @@unique([beatId, type])
}

model LicenseType {
  id         String      @id @default(uuid())
  code       LicenseCode @unique
  termsJson  Json
  priceCents Int
  currency   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  priceOverrides PriceOverride[]
  cartItems  CartItem[]
  orderItems OrderItem[]
}

model PriceOverride {
  id             String       @id @default(uuid())
  beatId         String
  licenseTypeId  String
  priceCents     Int
  beat           Beat         @relation(fields: [beatId], references: [id], onDelete: Cascade)
  licenseType    LicenseType  @relation(fields: [licenseTypeId], references: [id], onDelete: Cascade)

  @@unique([beatId, licenseTypeId])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id                       String     @id @default(uuid())
  cartId                   String
  beatId                   String
  licenseTypeId            String
  qty                      Int        @default(1)
  unitPriceSnapshotCents   Int
  createdAt                DateTime   @default(now())
  cart                     Cart       @relation(fields: [cartId], references: [id], onDelete: Cascade)
  beat                     Beat       @relation(fields: [beatId], references: [id])
  licenseType              LicenseType @relation(fields: [licenseTypeId], references: [id])

  @@unique([cartId, beatId, licenseTypeId])
  @@index([beatId])
  @@index([licenseTypeId])
}

model Order {
  id                    String       @id @default(uuid())
  userId                String
  status                OrderStatus  @default(pending)
  subtotalCents         Int
  taxCents              Int
  totalCents            Int
  currency              String
  stripePaymentIntentId String?
  stripeCheckoutSessionId String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                 OrderItem[]
}

model OrderItem {
  id               String      @id @default(uuid())
  orderId          String
  beatId           String
  licenseTypeId    String
  unitPriceCents   Int
  qty              Int          @default(1)
  downloadExpiresAt DateTime?
  createdAt        DateTime     @default(now())
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  beat             Beat         @relation(fields: [beatId], references: [id])
  licenseType      LicenseType  @relation(fields: [licenseTypeId], references: [id])
  downloadGrants   DownloadGrant[]

  @@index([orderId])
}

model DownloadGrant {
  id           String    @id @default(uuid())
  orderItemId  String
  assetId      String
  presignedKey String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  orderItem    OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  asset        Asset     @relation(fields: [assetId], references: [id])

  @@unique([orderItemId, assetId])
}

model WebhookEvent {
  id          String          @id @default(uuid())
  provider    WebhookProvider
  eventId     String          @unique
  type        String
  payloadJson Json
  processedAt DateTime?
  createdAt   DateTime        @default(now())
}

model Subscription {
  id              String             @id @default(uuid())
  userId          String
  stripeSubId     String             @unique
  status          SubscriptionStatus
  tier            SubscriptionTier
  currentPeriodEnd DateTime
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}
